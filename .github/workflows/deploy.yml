# ğŸš€ ContaPyme Deployment Pipeline - Enterprise Grade
name: ğŸŒ Deploy to Production

on:
  push:
    branches: [main]
    tags: [v*]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ğŸ—ï¸ Build for Production
  build:
    name: ğŸ—ï¸ Production Build
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}

    outputs:
      build-id: ${{ steps.build.outputs.build-id }}
      deployment-url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit --production=false
          npm ls --depth=0

      - name: ğŸŒ Set environment variables
        run: |
          echo "NEXT_PUBLIC_APP_VERSION=${{ github.sha }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_BUILD_TIME=$(date -Iseconds)" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_ENVIRONMENT=${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_ENV

      - name: ğŸ”’ Setup environment secrets
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "Environment configured for deployment"

      - name: ğŸ—ï¸ Build application
        id: build
        run: |
          npm run build
          BUILD_ID=$(date +%s)
          echo "build-id=$BUILD_ID" >> $GITHUB_OUTPUT
        env:
          CI: true
          NODE_ENV: production

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: production-build-${{ steps.build.outputs.build-id }}
          path: |
            .next/
            public/
            package.json
            next.config.js
          retention-days: 30

  # ğŸš€ Deploy to Vercel
  deploy-vercel:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”§ Install Vercel CLI
        run: npm install --global vercel@canary

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: production-build-${{ needs.build.outputs.build-id }}

      - name: ğŸš€ Deploy to Vercel
        id: deploy
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "staging" ]]; then
            DEPLOYMENT_URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }})
          else
            DEPLOYMENT_URL=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }})
          fi
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "ğŸŒ Deployed to: $DEPLOYMENT_URL"

      - name: ğŸ“ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Deployment successful!**\n\nğŸ“ **Environment:** ${{ github.event.inputs.environment || 'production' }}\nğŸ”— **URL:** ${{ steps.deploy.outputs.url }}\nâ° **Build ID:** ${{ needs.build.outputs.build-id }}\nğŸ·ï¸ **Commit:** ${context.sha.substring(0, 7)}`
            })

  # ğŸ§ª Post-Deployment Tests
  post-deploy-tests:
    name: ğŸ§ª Post-Deploy Tests
    runs-on: ubuntu-latest
    needs: [deploy-vercel]
    if: always() && needs.deploy-vercel.result == 'success'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”§ Install dependencies
        run: npm ci --prefer-offline

      - name: ğŸŒ Wait for deployment
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30

      - name: ğŸ” Health check
        run: |
          curl -f ${{ needs.deploy-vercel.outputs.deployment-url }}/api/health || exit 1
          echo "âœ… Health check passed"

      - name: ğŸ”’ Security headers check
        run: |
          curl -I ${{ needs.deploy-vercel.outputs.deployment-url }} | grep -E "(X-Frame-Options|X-Content-Type-Options|Strict-Transport-Security)"
          echo "âœ… Security headers verified"

      - name: âš¡ Performance check
        run: |
          npx lighthouse ${{ needs.deploy-vercel.outputs.deployment-url }} --chrome-flags="--headless" --output=json --output-path=lighthouse-results.json
          echo "âœ… Performance check completed"

      - name: ğŸ“Š Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-performance-report
          path: lighthouse-results.json
          retention-days: 30

  # ğŸ“Š Database Migration (if needed)
  migrate-database:
    name: ğŸ“Š Database Migration
    runs-on: ubuntu-latest
    needs: [deploy-vercel]
    if: github.event.inputs.environment == 'production' || github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Run database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          # Run any necessary database migrations
          echo "ğŸ”„ Running database migrations..."
          # npx supabase db migrate up --project-ref $SUPABASE_PROJECT_ID
          echo "âœ… Database migrations completed"

  # ğŸ”” Notifications
  notify:
    name: ğŸ”” Deployment Notifications
    runs-on: ubuntu-latest
    needs: [deploy-vercel, post-deploy-tests]
    if: always()

    steps:
      - name: ğŸ“§ Email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ContaPyme Deployment ${{ needs.deploy-vercel.result == 'success' && 'âœ… Successful' || 'âŒ Failed' }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ContaPyme CI/CD <noreply@contapyme.cl>
          html_body: |
            <h2>ContaPyme Deployment Report</h2>
            <p><strong>Environment:</strong> ${{ github.event.inputs.environment || 'production' }}</p>
            <p><strong>Status:</strong> ${{ needs.deploy-vercel.result == 'success' && 'âœ… Successful' || 'âŒ Failed' }}</p>
            <p><strong>URL:</strong> <a href="${{ needs.deploy-vercel.outputs.deployment-url }}">${{ needs.deploy-vercel.outputs.deployment-url }}</a></p>
            <p><strong>Commit:</strong> ${{ github.sha }}</p>
            <p><strong>Timestamp:</strong> $(date)</p>

      - name: ğŸ’¬ Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.deploy-vercel.result == 'success' && 'success' || 'failure' }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow

  # ğŸ¯ Release Management
  create-release:
    name: ğŸ¯ Create Release
    runs-on: ubuntu-latest
    needs: [deploy-vercel, post-deploy-tests]
    if: github.ref == 'refs/heads/main' && needs.deploy-vercel.result == 'success'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Generate release tag
        id: tag
        run: |
          TAG=v$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: ğŸ“ Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: 'ContaPyme Release ${{ steps.tag.outputs.tag }}'
          body: |
            ## ğŸš€ ContaPyme Production Release

            **Deployment URL:** ${{ needs.deploy-vercel.outputs.deployment-url }}
            **Build ID:** ${{ needs.build.outputs.build-id }}
            **Commit:** ${{ github.sha }}

            ### Changes in this release:
            ${{ github.event.head_commit.message }}

            ### Verification:
            - âœ… Build successful
            - âœ… Tests passed
            - âœ… Security checks completed
            - âœ… Performance verified
          draft: false
          prerelease: false