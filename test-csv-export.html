<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Exportaci√≥n CSV Corregida</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>üîß Test Exportaci√≥n CSV F29 - Codificaci√≥n Corregida</h1>
    
    <div class="result">
        <h3>üéØ Problema Identificado:</h3>
        <p>‚úÖ <strong>Caracteres especiales</strong> en campos como "Per√≠odo", "D√©bito", "Cr√©ditos"</p>
        <p>‚úÖ <strong>Falta BOM (Byte Order Mark)</strong> para compatibilidad con Excel</p>
        <p>‚úÖ <strong>Codificaci√≥n UTF-8</strong> incorrecta en blob</p>
    </div>

    <div class="result success">
        <h3>üõ†Ô∏è Soluciones Aplicadas:</h3>
        <p>‚úÖ Removidas tildes: "Per√≠odo" ‚Üí "Periodo", "D√©bito" ‚Üí "Debito"</p>
        <p>‚úÖ Agregado BOM UTF-8 (0xEF, 0xBB, 0xBF) para Excel</p>
        <p>‚úÖ Mejorado encapsulado de campos con comillas dobles</p>
        <p>‚úÖ Codificaci√≥n correcta con TextEncoder</p>
    </div>

    <button onclick="testOriginalExport()">‚ùå Probar M√©todo Original (Con problemas)</button>
    <button onclick="testCorrectedExport()">‚úÖ Probar M√©todo Corregido</button>

    <div id="results"></div>

    <script>
        // Datos de prueba F29
        const testResult = {
            rut: '76.926.806-5',
            periodo: '202411',
            codigo563: 22658507,
            codigo538: 4305260,
            codigo537: 1911129,
            codigo062: 56646,
            codigo077: 0,
            codigo048: 0,
            codigo049: 30639,
            codigo562: 1485730,
            codigo151: 0,
            comprasNetas: 22659263,
            ivaDeterminado: 2394131,
            margenBruto: 0,
            totalAPagar: 2481416,
            confidence: 100,
            method: 'Precision Parser - Caracteres Normalizados'
        };

        function showResult(message, isSuccess = true) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${isSuccess ? 'success' : 'error'}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        // M√©todo original con problemas
        function testOriginalExport() {
            const csvData = [
                ['Campo', 'Valor', 'C√≥digo'], // ‚ùå Con tilde
                ['RUT', testResult.rut, ''],
                ['Per√≠odo', testResult.periodo, ''], // ‚ùå Con tilde
                ['Ventas Netas', testResult.codigo563.toString(), '563'],
                ['D√©bito Fiscal', testResult.codigo538.toString(), '538'], // ‚ùå Con tilde
                ['Total Cr√©ditos', testResult.codigo537.toString(), '537'], // ‚ùå Con tilde
                ['M√©todo', testResult.method, ''] // ‚ùå Con tilde
            ];

            const csvContent = csvData.map(row => row.join(',')).join('\\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            downloadFile(blob, 'F29_ORIGINAL_CON_PROBLEMAS.csv');
            showResult('‚ùå <strong>Exportado con m√©todo original</strong><br>- Contiene tildes problem√°ticas<br>- Sin BOM para Excel<br>- Campos sin encapsular', false);
        }

        // M√©todo corregido
        function testCorrectedExport() {
            const csvData = [
                ['Campo', 'Valor', 'Codigo'], // ‚úÖ Sin tilde
                ['RUT', testResult.rut, ''],
                ['Periodo', testResult.periodo, ''], // ‚úÖ Sin tilde
                ['Ventas Netas', testResult.codigo563.toString(), '563'],
                ['Debito Fiscal', testResult.codigo538.toString(), '538'], // ‚úÖ Sin tilde
                ['Total Creditos', testResult.codigo537.toString(), '537'], // ‚úÖ Sin tilde
                ['PPM', testResult.codigo062.toString(), '062'],
                ['Remanente', testResult.codigo077.toString(), '077'],
                ['Prestamo Solidario', testResult.codigo049.toString(), '049'], // ‚úÖ Sin tilde
                ['Compras Netas Adicionales', testResult.codigo562.toString(), '562'],
                ['Compras Netas (Calculado)', testResult.comprasNetas.toString(), 'Calc'],
                ['IVA Determinado', testResult.ivaDeterminado.toString(), 'Calc'],
                ['Margen Bruto', testResult.margenBruto.toString(), 'Calc'],
                ['Total a Pagar', testResult.totalAPagar.toString(), 'Calc'],
                ['Confianza (%)', testResult.confidence.toString(), ''],
                ['Metodo', testResult.method, ''] // ‚úÖ Sin tilde
            ];

            // ‚úÖ Crear contenido CSV con BOM para compatibilidad con Excel
            const csvContent = csvData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\\n');
            const bomUtf8 = new Uint8Array([0xEF, 0xBB, 0xBF]); // BOM UTF-8
            const csvContentWithBom = new TextEncoder().encode(csvContent);
            const finalContent = new Uint8Array(bomUtf8.length + csvContentWithBom.length);
            finalContent.set(bomUtf8);
            finalContent.set(csvContentWithBom, bomUtf8.length);
            
            const blob = new Blob([finalContent], { type: 'text/csv;charset=utf-8;' });
            
            downloadFile(blob, 'F29_CORREGIDO_UTF8_BOM.csv');
            showResult('‚úÖ <strong>Exportado con m√©todo corregido</strong><br>- Sin caracteres especiales<br>- Con BOM UTF-8 para Excel<br>- Campos correctamente encapsulados<br>- Compatible con todos los sistemas', true);
        }

        function downloadFile(blob, filename) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>